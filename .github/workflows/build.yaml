name: "build"
on:
  push:
    paths-ignore:
      - '**/*.md'
  pull_request:
    paths-ignore:
      - '**/*.md'

permissions:
  contents: write

jobs:
  windows-build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: robinraju/release-downloader@v1.7
        with:
          repository: "Tencent/ncnn"
          latest: true
          fileName: "ncnn-*-windows-vs2022.zip"

      - name: Unzip
        shell: bash
        working-directory: ./native
        run: |
          unzip ncnn-*-windows-vs2022.zip
          mv ncnn-*-windows-vs2022 ncnn

  linux-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: robinraju/release-downloader@v1.7
        with:
          repository: "Tencent/ncnn"
          latest: true
          fileName: "ncnn-*-ubuntu-2204.zip"

      - name: Unzip
        shell: bash
        working-directory: ./native
        run: |
          unzip ncnn-*-ubuntu-2204.zip
          mv ncnn-*-ubuntu-2204 ncnn

  android-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: robinraju/release-downloader@v1.7
        with:
          repository: "Tencent/ncnn"
          latest: true
          fileName: "ncnn-*-android-vulkan.zip"

      - name: Unzip
        shell: bash
        working-directory: ./native
        run: |
          unzip ncnn-*-android-vulkan.zip
          mv ncnn-*-android-vulkan ncnn

      - name: Install Android NDK
        uses: nttld/setup-ndk@v1.2.0
        with:
          ndk-version: r25b

      - name: Build aarch64 ncnn
        shell: bash
        working-directory: ./native/ncnn
        run: |
          mkdir -p build-android-aarch64
          cd build-android-aarch64
          cmake -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI="arm64-v8a" \
            -DANDROID_PLATFORM=android-24 -DNCNN_VULKAN=ON
          make -j$(nproc)
          make install

  macos-build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: robinraju/release-downloader@v1.7
        with:
          repository: "Tencent/ncnn"
          latest: true
          fileName: "ncnn-*-macos-vulkan.zip"

      - name: Unzip
        shell: bash
        working-directory: ./native
        run: |
          unzip ncnn-*-macos-vulkan.zip
          mv ncnn-*-macos-vulkan ncnn